name: "ğŸŒ¸ Code Lyoko - Virtual World Loader ğŸŒ¸"

on:
  push:
    branches: [ master ]
  workflow_dispatch:
    inputs:
      config_label:
        description: 'ğŸ“¡ Selector to the secret config'
        required: true
        type: string
      
jobs:
  virtualization:
    name: "ğŸš€ Transfer to Lyoko"
    runs-on: ubuntu-latest
    
    steps:
      - name: "ğŸŒ¸ Kawaii Check desu~ âœ¨"
        if: github.event_name != 'workflow_dispatch'
        run: |
          echo 'âŒ Gomen ne~ This workflow only runs on workflow_dispatch! (ï½¡â€¢Ìï¸¿â€¢Ì€ï½¡)'
          exit 1
          
      - name: "ğŸ€ Initialize Supercomputer"
        run: |
          echo 'â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—'
          echo 'â•‘     CODE LYOKO INITIALIZATION        â•‘'
          echo 'â•‘         âˆ§,,,âˆ§                        â•‘'
          echo 'â•‘        ( Ì³â€¢ Â· â€¢ Ì³)                    â•‘'
          echo 'â•‘        /    ã¥â™¡  Loading...          â•‘'
          echo 'â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
          
      - name: "ğŸ” Configure SSH Neural Interface"
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          config=$(echo "${{ secrets.CONFIG }}" | jq -rc --arg l "${{ inputs.config_label }}" '.[] | select(.label==$l)')
          echo "$config"
          exit 1
          
          # Install private key from Supercomputer vault
          config=$(echo '${{ secrets.CONFIG }}' | jq -r --arg label "${{ inputs.config_label }}" '.[] | select(.label==$label')")
          echo '${{ secrets.CONFIG }}' | jq -r --arg label "${{ inputs.config_label }}" '.[$label].ssh_priv_key' >~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          
          # Load known hosts from quantum memory
          echo "${{ secrets.SSH_KNOWN_HOSTS }}" > ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts
          
          echo 'âœ¨ SSH neural link established! (â—•â€¿â—•)âœ¨'
          
      - name: "ğŸ“¥ Virtualize Target Repository"
        run: |
          echo 'ğŸŒ Initiating git transfer protocol...'

          sudo apt-get update -y
          sudo apt-get install -y jq

          git_url=$(echo '${{ secrets.CONFIG }}' | jq -r --arg label "${{ inputs.config_label }}" '.[$label].git_url')

          if test -z "$git_url"; then
            echo "Bad config label"
            exit 1
          fi

          git clone "$git_url" ~/app >/dev/null 2>/dev/null
          rm -f ~/.ssh/id_ed25519 ~/.ssh/known_hosts
          
          echo 'âœ… Virtualization complete! ãƒ½(Â´â–½`)/'
          
      - name: "ğŸ¯ Execute Initialization Sequence"
        run: |
          cd ~/app
          
          if [ -f "./lyoko.init.sh" ]; then
            echo 'ğŸ”§ Running initialization protocol...'
            echo 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”'
            chmod +x ./lyoko.init.sh
            ./lyoko.init.sh
            echo 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”'
            echo 'âœ¨ Initialization complete! (ï½¡â™¥â€¿â™¥ï½¡)'
          else
            echo 'âš ï¸  No init script detected - skipping (ï½¡â€¢Ìï¸¿â€¢Ì€ï½¡)'
          fi
          
      - name: "âš¡ Launch Main Program"
        run: |
          cd ~/app
          if [ -f "./lyoko.run.sh" ]; then
            echo 'ğŸš€ Launching main sequence...'
            echo 'â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—'
            echo 'â•‘   LYOKO.RUN.SH ACTIVATED      â•‘'
            echo 'â•‘      âˆ©___âˆ©                    â•‘'
            echo 'â•‘      |  ãƒ¼ _ãƒ¼ |               â•‘'
            echo 'â•‘      |  â— â—  |                â•‘'
            echo 'â•‘      |_____|                  â•‘'
            echo 'â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
            chmod +x ./lyoko.run.sh

            app_arg=$(echo '${{ secrets.CONFIG }}' | jq -r --arg label "${{ inputs.config_label }}" '.[$label].app_arg')
            
            # Execute with optional arguments
            if [ -n "$app_arg" ] && [ "$app_arg" != "null" ]; then
              ./lyoko.run.sh "$app_arg"
            else
              ./lyoko.run.sh
            fi
            
            echo 'âœ… Main program executed successfully! ï¼¼(^o^)ï¼'
          else
            echo 'âš ï¸  No run script detected - skipping à²¥_à²¥'
          fi
          
      - name: "ğŸ Execute Termination Protocol"
        run: |
          cd ~/app
          if [ -f "./lyoko.term.sh" ]; then
            echo 'ğŸ”š Initiating graceful shutdown...'
            echo 'â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”'
            echo 'â”‚   Returning from Lyoko...   â”‚'
            echo 'â”‚         âˆ§__âˆ§                â”‚'
            echo 'â”‚        ( Ë˜Ï‰Ë˜ )              â”‚'
            echo 'â”‚        âŠƒ    âŠ‚              â”‚'
            echo 'â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜'
            chmod +x ./lyoko.term.sh
            ./lyoko.term.sh
            echo 'ğŸ‘‹ See you next time, Lyoko Warrior! (â— â€¿â— âœ¿)'
          else
            echo 'âš ï¸  No termination script detected - skipping (â—â€¸â—Ÿ)'
          fi
          
      - name: "ğŸ“Š Final Status Report"
        if: always()
        run: |
          echo 'â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—'
          echo 'â•‘         MISSION COMPLETE               â•‘'
          echo 'â•‘                                        â•‘'
          echo "â•‘  Status: ${{ job.status }}             â•‘"
          echo 'â•‘                                        â•‘'
          echo 'â•‘        â™¡ Thank you for using â™¡        â•‘'
          echo 'â•‘          Code Lyoko Loader!            â•‘'
          echo 'â•‘                                        â•‘'
          echo 'â•‘              à¸…^â€¢ï»Œâ€¢^à¸…                   â•‘'
          echo 'â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
